<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User access count (IP based)</title>

    <style>
        body {
            background-color: #004C8F;
            color: #FFFFFF;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
        }
        table {
            width: 100%;
            background-color: white;
            color: black;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #000;
            padding: 6px;
        }
        th {
            background-color: #E6E6E6;
        }
    </style>
</head>

<body>

<h3>User Count (IP-based geolocation)</h3>

<table>
    <thead>
        <tr>
            <th>User Count</th>
            <th>Country</th>
            <th>Region</th>
            <th>City</th>
            <th>Continent</th>
        </tr>
    </thead>
    <tbody id="tbody"></tbody>
</table>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDSNanmji7WVBtQHlPO-J_E5RQu9Qlq4Qw",
        authDomain: "openmurugesan.firebaseapp.com",
        databaseURL: "https://openmurugesan-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "openmurugesan",
        storageBucket: "openmurugesan.firebasestorage.app",
        messagingSenderId: "307675598593",
        appId: "1:307675598593:web:4af163460ce2c3bc719500"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const tbody = document.getElementById("tbody");

    // -------- IP GEOLOCATION --------
    async function detectLocation() {
        try {
            const res = await fetch("https://ipapi.co/json/");
            const data = await res.json();

            return {
                country: data.country_name || "UNKNOWN",
                region: data.region || "UNKNOWN",
                city: data.city || "UNKNOWN",
                continent: data.continent_code || "UNKNOWN",
                ip: data.ip || "UNKNOWN"
            };
        } catch (e) {
            return {
                country: "UNKNOWN",
                region: "UNKNOWN",
                city: "UNKNOWN",
                continent: "UNKNOWN",
                ip: "UNKNOWN"
            };
        }
    }

    // -------- STORE VISIT --------
    async function storeVisit() {
        const geo = await detectLocation();

        await push(ref(db, "userAccess"), {
            country: geo.country|| "UNKNOWN",
            region: geo.region|| "UNKNOWN",
            city: geo.city|| "UNKNOWN",
            continent: geo.continent|| "UNKNOWN",
            ip: geo.ip,
            userAgent: navigator.userAgent,
            timestamp: Date.now()
        });
    }

    storeVisit();

    // -------- DISPLAY COUNTS --------
    onValue(ref(db, "userAccess"), snapshot => {
        tbody.innerHTML = "";
        if (!snapshot.exists()) return;
const continentMap = { 
  "AS": "Asia",
  "NA": "North America",
  "EU": "Europe",
  "AF": "Africa",
  "OC": "Oceania",
  "SA": "South America",
  "AN": "Antarctica",
  "OS": "Oceania",
   "???": "what to write"
};        const counts = {};

snapshot.forEach(child => {
            const v = child.val();
            const country = v.country || "UNKNOWN";
            const region = v.region || "UNKNOWN";
            const city = v.city || "UNKNOWN";
            let continentCode = v.continent || "UNKNOWN";
            switch(country.toUpperCase()) {
    case "INDIA":
        continentCode = "AS";
        break;
	case "Pacific Islands":
		continentCode = "OS";
		break;
    case "UNITED STATES":
    case "AMERICA/LOS_ANGELES":
    case "USA (HAWAII-ALEUTIAN TIME ZONE)":
    case "USA (PACIFIC TIME ZONE)":
        continentCode = "NA";
        break;
    case "RUSSIA":
        // optional: choose EU or AS depending on region
        continentCode = "EU";
        break;
    case "AUSTRALIA":
    case "FIJI":
    case "SAMOA":
    case "TONGA":
    case "VANUATU":
    case "SOLOMON ISLANDS":
        continentCode = "OC"; // Oceania
        break;
    case "BRAZIL":
    case "ARGENTINA":
    case "CHILE":
        continentCode = "SA"; // South America
        break;
    case "EGYPT":
    case "NIGERIA":
    case "SOUTH AFRICA":
        continentCode = "AF"; // Africa
        break;
    case "UNITED KINGDOM":
    case "FRANCE":
    case "GERMANY":
        continentCode = "EU"; // Europe
        break;
case "CHINA":
case "JAPAN":
case "INDONESIA":
case "Asia/Calcutta":
    continentCode = "AS"; // Asia
    break;

case "CANADA":
case "MEXICO":
    continentCode = "NA"; // North America
    break;

case "NEW ZEALAND":
case "PAPUA NEW GUINEA":
    continentCode = "OC"; // Oceania
    break;

case "ARGENTINA":
case "PERU":
case "COLOMBIA":
    continentCode = "SA"; // South America
    break;

case "SOUTH AFRICA":
case "KENYA":
    continentCode = "AF"; // Africa
    break;

case "FRANCE":
case "GERMANY":
case "ITALY":
    continentCode = "EU"; // Europe
    break;
            }
			if( country === "India" || "INDIA" === country )
			{
				continentCode = "AS";
			}
			const continent = continentMap[continentCode] || "UNKNOWN";
            const key = `${country}|${continent}|${region}|${city}`;
            counts[key] = (counts[key] || 0) + 1;
        });
        Object.keys(counts).forEach(k => {
            const [country, continent, region, city] = k.split("|");
            tbody.innerHTML += `
                <tr>
                    <td align="center">${String(counts[k]).padStart(4,"0")}</td>
                    <td>${country}</td>
                    <td>${region}</td>
                    <td>${city}</td>
                    <td>${continent}</td>
                </tr>`;
        });
    });
</script>

</body>
</html>
